# src/gateway/nginx.conf
http {
   # API 호출 제한 설정 (공공데이터 포털 API 제한: 초당 50회)
   limit_req_zone $binary_remote_addr zone=api_limit:10m rate=45r/s;
   
   # 업스트림 서버 설정
   upstream fastapi_servers {
       server 127.0.0.1:8000;
       server 127.0.0.1:8001 backup;
   }

   server {
       listen 80;
       
       location /api/ {
           # FastAPI 서버로 프록시
           proxy_pass http://fastapi_servers;
           
           # 헤더 설정
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           
           # Rate limiting 적용
           limit_req zone=api_limit burst=5 nodelay;
           
           # 타임아웃 설정
           proxy_connect_timeout 60s;
           proxy_send_timeout 60s;
           proxy_read_timeout 60s;
           
           # 버퍼 설정
           proxy_buffering on;
           proxy_buffer_size 128k;
           proxy_buffers 4 256k;
           
           # 에러 처리
           proxy_intercept_errors on;
           error_page 500 502 503 504 /50x.html;
       }

       # Prometheus 메트릭스
       location /metrics {
           proxy_pass http://fastapi_servers;
       }

       # 상태 확인
       location /health {
           proxy_pass http://fastapi_servers;
       }

       # API 문서
       location /docs {
           proxy_pass http://fastapi_servers;
       }
   }
}